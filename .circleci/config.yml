version: 2

jobs:
  build:
    docker:
      - image: circleci/php:7.1.8-browsers
    working_directors: ~/laravel
    steps:
      - checkout
      - persist_to_workspace:
          root: ~/laravel
          paths:
            - ./*
      # - run: sudo apt install -y libsqlite3-dev
      # - run: composer self-update
      - restore_cache:
          keys:
            - composer-v1-{{ checksum "composer.json" }}
            - composer-v1-
      - run: composer install -n --prefer-dist
      - save_cache:
          key: composer-v1-{{ checksum "composer.json" }}
          paths:
            - vendor

  deploy:
    docker:
      - image: amazonlinux
    working_directory: ~/laravel
    steps:
      - attach_workspace:
          at: ~/laravel
      - run:
          name: Setup AWS-CLI
          command: |
            curl -kL https://bootstrap.pypa.io/get-pip.py | python
            pip install awscli --upgrade
            aws --version
      - deploy:
          name: Deploy to EC2
          command: |
              GITHUB_REPO=`echo $CIRCLE_REPOSITORY_URL | sed -e 's/git@github.com://' | sed -e 's/.git$//' `
              DEPLOYMENTID=`aws deploy create-deployment \
                  --application-name StartByCircleCI \
                  --github-location repository=${GITHUB_REPO},commitId=${CIRCLE_SHA1} \
                  --deployment-group-name ${CIRCLE_BRANCH}-group \
                  --region ap-northeast-1 \
                  --query 'deploymentId' --output text`
              aws deploy wait deployment-successful --region ap-northeast-1 --deployment-id $DEPLOYMENTID

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build:
          filters:
            branches:
              - master
              - staging
      - deploy:
          requires:
            - build
