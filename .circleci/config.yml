version: 2

jobs:
  build:
    docker:
      - image: circleci/php:7.1.8-browsers
    steps:
      - checkout
      # - run: sudo apt install -y libsqlite3-dev
      # - run: composer self-update
      - restore_cache:
          keys:
            - composer-v1-{{ checksum "composer.json" }}
            - composer-v1-
      - run: composer install -n --prefer-dist
      - save_cache:
          key: composer-v1-{{ checksum "composer.json" }}
          paths:
            - vendor
      - persist_to_workspace:
          root: ~/project
          paths:
            - ./*

  deploy:
    docker:
      - image: amazonlinux
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Setup AWS-CLI
          command: |
            curl -kL https://bootstrap.pypa.io/get-pip.py | python
            pip install awscli --upgrade
            aws --version
            ls
      - deploy:
          name: Deploy to EC2
          command: |
              aws deploy push --application-name StartByCircleCI --s3-location \
              s3://codedeploy-for-aws-study/${CIRCLE_PROJECT_REPONAME}-CircleCI-Build-${CIRCLE_BUILD_NUM}.zip
              DEPLOYMENTID=`aws deploy create-deployment \
                  --application-name StartByCircleCI \
                  --s3-location bucket=codedeploy-for-aws-study,key=${CIRCLE_PROJECT_REPONAME}-CircleCI-Build-${CIRCLE_BUILD_NUM}.zip,bundleType=zip \
                  --deployment-group-name ${CIRCLE_BRANCH}-group \
                  --region ap-northeast-1 \
                  --query 'deploymentId' --output text`
              aws deploy wait deployment-successful --region ap-northeast-1 --deployment-id $DEPLOYMENTID

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build:
          filters:
            branches:
              only:
                - master
                - staging
      - deploy:
          requires:
            - build
